##########  Рассчет дохода Арбитража  ############

# Очистка переменных
rm(list=ls())

# Цена, по которой мы  можем купить BTC
BUY.price <- c(10.1,10.3,10.4,10.7,10.9,11.2,11.3)
# Комиссия на BUY и курс с учетом комиссии
a <- 0.02
BUY.price <- (1+a)*BUY.price
# Объем (кумулятивный) BTC в доллах, который мы можем купить
BUY.volume <- c(200,500,600,800,1000,1100,1300)
# Цена, по которой мы  можем продать BTC
SELL.price <- c(10.8,10.6,10.4,10.3,10.2,9.9,9.7)
# Комиссия на SELL и курс с учетом комиссии
b <- 0.01
SELL.price <- (1-b)*SELL.price
# Объем (кумулятивный) BTC в долларах, который мы можем продать
SELL.volume <- c(400,600,1100,1400,1700,1900,2000)
# Формируем пары цена-объем
BUY <- data.frame(BUY.price,BUY.volume)
BUY
SELL <- data.frame(SELL.price,SELL.volume)
SELL

# Определяем - будет ли сделка
BUY.price.min <- min(BUY$BUY.price)
SELL.price.max <- max(SELL$SELL.price)
if (BUY.price.min >= SELL.price.max) stop("NO DEAL!") else print("WE'll DEAL!")
# Цена BUY, до которой мы пожем покупать, если будет соответствующий объем 
BUY.price.max <- max(BUY$BUY.price)
BUY.price.limit <- min(BUY.price.max,SELL.price.max)
#print("Limit good BUY price")
#BUY.price.limit

# Оставляем только хорошие ордера
BUY.GOOD <- BUY[BUY$BUY.price < BUY.price.limit,]
#BUY.GOOD
SELL.GOOD <- SELL[SELL$SELL.price > BUY.price.min,]
#SELL.GOOD

# Определяем максимальный объем сделки
print("The maximum volume in $")
VOLUME.limit.max <- min(max(BUY.GOOD$BUY.volume),max(SELL.GOOD$SELL.volume))
VOLUME.limit.max
print("OUR volume in $")
VOLUME.limit.our <- 550
VOLUME.limit.our
VOLUME.limit <- min(VOLUME.limit.max,VOLUME.limit.our)

# Переменные для анализа
VOLUME.CURR <- 0
Profit.in.USD <-0
Amount.in.USD <-0
k.max <-20 # Кол-во точек для анализа

for (k in 1:k.max) {
VOLUME.CURR <- VOLUME.CURR+1/k.max*VOLUME.limit
# Находим текущую среднюю BUY цену с учетом объемов ордеров
i <- 1
MINUS <- BUY.GOOD$BUY.volume[i]*BUY.GOOD$BUY.price[i]
while (BUY.GOOD$BUY.volume[i] < VOLUME.CURR) {
  i <- i+1
  MINUS <- MINUS+(BUY.GOOD$BUY.volume[i]-BUY.GOOD$BUY.volume[i-1])*BUY.GOOD$BUY.price[i]
  }
if (BUY.GOOD$BUY.volume[i]>VOLUME.CURR) MINUS <- MINUS-(BUY.GOOD$BUY.volume[i]-VOLUME.CURR)*BUY.GOOD$BUY.price[i]
# Средняя текущая BUY цена
Prise.weight.BUY <- MINUS/VOLUME.CURR

# Находим текущую среднюю SELL цену объемов ордеров
j <- 1
PLUS <- SELL.GOOD$SELL.volume[j]*SELL.GOOD$SELL.price[j]
while (SELL.GOOD$SELL.volume[j] < VOLUME.CURR) {
  j <- j+1
  PLUS <- PLUS+(SELL.GOOD$SELL.volume[j]-SELL.GOOD$SELL.volume[j-1])*SELL.GOOD$SELL.price[j]
}
if (SELL.GOOD$SELL.volume[j]>VOLUME.CURR) PLUS <- PLUS-(SELL.GOOD$SELL.volume[j]-VOLUME.CURR)*SELL.GOOD$SELL.price[j]
# Средняя текущая SELL цена
Prise.weight.SELL <- PLUS/VOLUME.CURR

# Доход
PERCENT <- (Prise.weight.SELL-Prise.weight.BUY)/Prise.weight.BUY
PROFIT <- PERCENT*VOLUME.CURR
Profit.in.USD[k] <- PROFIT
Amount.in.USD[k] <- VOLUME.CURR
}

# Вывод результатов
plot(Amount.in.USD,Profit.in.USD)
print("THE MAXIMUM PROFIT AND AMOUNT")
ALL.plot.data <- data.frame(Profit.in.USD,Amount.in.USD)
BEST.plot.data <- ALL.plot.data[ALL.plot.data$Profit.in.USD == max(Profit.in.USD),]
round(BEST.plot.data,2)

